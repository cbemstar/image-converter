<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image to WebP Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    img.preview { max-width: 120px; max-height: 120px; border-radius: 6px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <h1 class="text-3xl font-bold text-center mt-8 mb-6 text-gray-800">Image to WebP Converter</h1>
  <div id="controls" class="flex flex-wrap justify-center gap-4 mb-8">
    <div class="bg-white rounded shadow px-3 py-2 flex items-center gap-2">
      <span class="font-medium">Max Width:</span>
      <span class="text-blue-700">3840 px</span>
    </div>
    <div class="bg-white rounded shadow px-3 py-2 flex items-center gap-2">
      <span class="font-medium">Max Height:</span>
      <span class="text-blue-700">9999 px</span>
    </div>
    <div class="bg-white rounded shadow px-3 py-2 flex items-center gap-2">
      <span class="font-medium">Quality:</span>
      <span class="text-blue-700">0.95</span>
    </div>
  </div>
  <div id="drop-area" class="border-2 border-dashed border-blue-400 rounded-lg p-8 text-center text-blue-500 mb-8 bg-white shadow hover:shadow-lg transition-shadow cursor-pointer max-w-2xl mx-auto">
    <p class="mb-4">Drag & drop your image files here</p>
    <input type="file" id="fileElem" accept="image/*" multiple style="display:none">
    <button onclick="fileElem.click()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-2 rounded shadow transition-colors">Select Images</button>
  </div>
  <div id="progress" class="text-center text-lg font-medium text-blue-700 mb-4"></div>
  <a id="download-link" href="#" download="converted_images.zip" class="hidden bg-green-500 hover:bg-green-600 text-white font-semibold px-6 py-2 rounded shadow transition-colors mx-auto block w-fit">Download All as ZIP</a>
  <div class="overflow-x-auto max-w-5xl mx-auto px-2 sm:px-4 min-w-0">
    <table id="preview-table" class="min-w-full w-full bg-white rounded shadow mb-8 text-sm sm:text-base table-auto">
      <thead>
        <tr class="bg-blue-100 text-blue-900">
          <th class="py-2 px-2 sm:px-4">#</th>
          <th class="py-2 px-2 sm:px-4">Preview</th>
          <th class="py-2 px-2 sm:px-4">Original Filename</th>
          <th class="py-2 px-2 sm:px-4">WebP Size</th>
          <th class="py-2 px-2 sm:px-4">Download</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');
    const progress = document.getElementById('progress');
    const downloadLink = document.getElementById('download-link');
    const previewTable = document.getElementById('preview-table');
    const previewTbody = previewTable.querySelector('tbody');
    const MAX_WIDTH = 3840;
    const MAX_HEIGHT = 9999;
    const QUALITY = 0.95;

    dropArea.addEventListener('dragover', e => {
      e.preventDefault();
      dropArea.style.borderColor = '#333';
    });
    dropArea.addEventListener('dragleave', e => {
      e.preventDefault();
      dropArea.style.borderColor = '#888';
    });
    dropArea.addEventListener('drop', e => {
      e.preventDefault();
      dropArea.style.borderColor = '#888';
      handleFiles(e.dataTransfer.files);
    });
    fileElem.addEventListener('change', e => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      if (!files.length) return;
      const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
      if (!imageFiles.length) {
        alert('Please select image files only.');
        return;
      }
      progress.textContent = `Processing ${imageFiles.length} image(s)...`;
      previewTbody.innerHTML = '';
      previewTable.classList.remove('hidden');
      previewTable.classList.add('table');
      processImages(imageFiles);
    }

    async function processImages(files) {
      const zip = new JSZip();
      let processed = 0;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
          const webpBlob = await convertToWebP(file, MAX_WIDTH, MAX_HEIGHT, QUALITY);
          const filename = file.name.replace(/\.[^.]+$/, '') + '.webp';
          zip.file(filename, webpBlob);
          showPreview(i + 1, file, webpBlob, filename);
        } catch (err) {
          showError(i + 1, file.name, err);
        }
        processed++;
        progress.textContent = `Processed ${processed} of ${files.length} image(s).`;
      }
      if (files.length > 1) {
        const zipBlob = await zip.generateAsync({type: 'blob'});
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.style.display = 'inline-block';
        progress.textContent = `Done! Download all converted images as ZIP below.`;
      } else {
        downloadLink.style.display = 'none';
      }
    }

    function showPreview(index, file, webpBlob, filename) {
      const tr = document.createElement('tr');
      const reader = new FileReader();
      reader.onload = function(e) {
        let size = webpBlob.size;
        let sizeStr = size < 1024*1024 ? (size/1024).toFixed(1) + ' KB' : (size/1024/1024).toFixed(2) + ' MB';
        const downloadUrl = URL.createObjectURL(webpBlob);
        tr.innerHTML = `
          <td class="align-top py-2 px-2 sm:px-4">${index}</td>
          <td class="align-top py-2 px-2 sm:px-4"><img class="preview" src="${e.target.result}" alt="preview"></td>
          <td class="align-top py-2 px-2 sm:px-4 break-words whitespace-normal max-w-[180px] sm:max-w-xs">${file.name}</td>
          <td class="align-top py-2 px-2 sm:px-4">${sizeStr}</td>
          <td class="align-top py-2 px-2 sm:px-4"><a href="${downloadUrl}" download="${filename}" class="download-btn text-blue-600 hover:underline">Download</a></td>
        `;
        previewTbody.appendChild(tr);
      };
      reader.readAsDataURL(webpBlob);
    }

    function showError(index, filename, err) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="align-top py-2 px-2 sm:px-4">${index}</td>
        <td class="align-top py-2 px-2 sm:px-4" style="color:red;">Failed</td>
        <td class="align-top py-2 px-2 sm:px-4">${filename}</td>
        <td class="align-top py-2 px-2 sm:px-4"></td>
        <td class="align-top py-2 px-2 sm:px-4"></td>
      `;
      previewTbody.appendChild(tr);
    }

    async function convertToWebP(file, maxW, maxH, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function() {
          let [w, h] = [img.width, img.height];
          let scale = Math.min(maxW / w, maxH / h, 1);
          let nw = Math.round(w * scale), nh = Math.round(h * scale);
          const canvas = document.createElement('canvas');
          canvas.width = nw;
          canvas.height = nh;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, nw, nh);
          canvas.toBlob(blob => {
            if (!blob) reject(new Error('Conversion failed'));
            else resolve(blob);
          }, 'image/webp', quality);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }
  </script>
</body>
</html>
